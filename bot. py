import os
import pandas as pd
from pyrogram import Client, filters
from pyrogram.types import ReplyKeyboardMarkup, ForceReply

# ржХрзНрж░рзЗржбрзЗржирж╢рж┐рзЯрж╛рж▓ рж╕рзЗржЯржЖржк
api_id = 39509829
api_hash = "e11187f10974a3416ddf2fc52101a7d9"
bot_token = os.environ.get("BOT_TOKEN", "8338204876:AAG8Y3F30W115DyG3HkwvTRGkbHayGh43Ss")

app = Client("vcf_pro_bot", api_id=api_id, api_hash=api_hash, bot_token=bot_token)

# рж╕рзНржЯрзЛрж░рзЗржЬ (ржЯрзЗржорзНржкрзЛрж░рж╛рж░рж┐ ржбрж╛ржЯрж╛ рж░рж╛ржЦрж╛рж░ ржЬржирзНржп)
user_data = {}

# ржорзЗржирзБ ржХрж┐ржмрзЛрж░рзНржб
main_menu = ReplyKeyboardMarkup(
    [
        ["/to_vcf", "/to_txt", "/admin", "/manual"],
        ["/add", "/delete", "/renamectc", "/renamefile"],
        ["/merge", "/split", "/count", "/nodup"],
        ["/getname", "/generate", "/getconten", "/setting"],
        ["/status", "/vip", "/referral", "/help"]
    ],
    resize_keyboard=True
)

@app.on_message(filters.command("start"))
async def start(client, message):
    await message.reply_text(
        "ЁЯСЛ рж╕рзНржмрж╛ржЧрждржо! VCF ржХржиржнрж╛рж░рзНржЯрж╛рж░ ржмрзЛржЯрзЗред\nржХрж╛ржЬ рж╢рзБрж░рзБ ржХрж░рждрзЗ ржирж┐ржЪрзЗрж░ ржорзЗржирзБ ржерзЗржХрзЗ **/to_vcf** рж╕рж┐рж▓рзЗржХрзНржЯ ржХрж░рзБржиред",
        reply_markup=main_menu
    )

@app.on_message(filters.command("to_vcf"))
async def ask_file(client, message):
    await message.reply_text("ЁЯУй ржжрзЯрж╛ ржХрж░рзЗ ржЖржкржирж╛рж░ ржХржирзНржЯрж╛ржХрзНржЯ рж▓рж┐рж╕рзНржЯрзЗрж░ **.txt** ржЕржержмрж╛ **.xlsx** ржлрж╛ржЗрж▓ржЯрж┐ ржкрж╛ржарж╛ржиред")

@app.on_message(filters.document)
async def handle_document(client, message):
    file_ext = message.document.file_name.split('.')[-1].lower()
    if file_ext in ['txt', 'xlsx']:
        file_path = await message.download()
        user_data[message.from_user.id] = {'file_path': file_path}
        await message.reply_text("тЬЕ ржлрж╛ржЗрж▓ ржкрж╛ржУрзЯрж╛ ржЧрзЗржЫрзЗред ржХржиржнрж╛рж░рзНржЯ рж╢рзБрж░рзБ ржХрж░рждрзЗ ржЯрж╛ржЗржк ржХрж░рзБржи: `/done`")
    else:
        await message.reply_text("тЭМ ржжрзБржГржЦрж┐ржд! рж╢рзБржзрзБ .txt ржмрж╛ .xlsx ржлрж╛ржЗрж▓ ржкрж╛ржарж╛ржиред")

@app.on_message(filters.command("done"))
async def ask_contact_name(client, message):
    await message.reply_text("ЁЯУЭ ржХржирзНржЯрж╛ржХрзНржЯ рж╕рзЗржн ржХрж░рж╛рж░ ржЬржирзНржп ржПржХржЯрж┐ **ржирж╛ржо** ржжрж┐ржи (ржпрзЗржоржи: Yesss):", reply_markup=ForceReply(True))

@app.on_message(filters.reply & filters.text)
async def process_conversion(client, message):
    uid = message.from_user.id
    if uid not in user_data: return

    # ржХржирзНржЯрж╛ржХрзНржЯ ржирж╛ржо ржПржмржВ ржлрж╛ржЗрж▓ ржирж╛ржо рж╕рзЗржЯржЖржк
    if 'ctc_name' not in user_data[uid]:
        user_data[uid]['ctc_name'] = message.text
        await message.reply_text("ЁЯТ╛ ржПржмрж╛рж░ ржлрж╛ржЗрж▓рзЗрж░ ржЬржирзНржп ржПржХржЯрж┐ ржирж╛ржо ржжрж┐ржи (ржпрзЗржоржи: Injay):", reply_markup=ForceReply(True))
        return
    
    if 'file_name' not in user_data[uid]:
        user_data[uid]['file_name'] = message.text
        await message.reply_text("ЁЯФв ржкрзНрж░рждрж┐ ржлрж╛ржЗрж▓рзЗ ржХрждржЧрзБрж▓рзЛ ржХржирзНржЯрж╛ржХрзНржЯ ржерж╛ржХржмрзЗ? (ржпрзЗржоржи: 200 ржЕржержмрж╛ рж╕ржмржЧрзБрж▓рзЛрж░ ржЬржирзНржп 'all'):", reply_markup=ForceReply(True))
        return

    # ржХржиржнрж╛рж░рж╢ржи рж╢рзБрж░рзБ
    limit_text = message.text
    ctc_name = user_data[uid]['ctc_name']
    file_prefix = user_data[uid]['file_name']
    input_file = user_data[uid]['file_path']

    await message.reply_text("тП│ ржлрж╛ржЗрж▓ ржкрзНрж░рж╕рзЗрж╕рж┐ржВ рж╣ржЪрзНржЫрзЗ... ржжрзЯрж╛ ржХрж░рзЗ ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзБржиред")
